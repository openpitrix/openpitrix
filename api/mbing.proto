// Copyright 2018 The OpenPitrix Authors. All rights reserved.
// Use of this source code is governed by a Apache license
// that can be found in the LICENSE file.

syntax = "proto3";

package openpitrix;

// set go package name to pb
option go_package = "pb";

import "google/protobuf/wrappers.proto";
import "google/protobuf/timestamp.proto";
import "google/api/annotations.proto";
import "protoc-gen-swagger/options/annotations.proto";


enum Currency {
	CNY = 0;
	HKD = 1;
	USD = 2;
}

//************************************* Price *************************

message Attribute {
	google.protobuf.StringValue id = 1;
	google.protobuf.StringValue name = 2;
	google.protobuf.StringValue display_name = 3;
	google.protobuf.StringValue remark = 4;
}

message AttributeUnit {
	google.protobuf.StringValue id = 1;
	google.protobuf.StringValue name = 2;
	google.protobuf.StringValue display_name = 3;
}

message AttributeValue {
	google.protobuf.StringValue id = 1;
	google.protobuf.StringValue attribute_id = 2;
	google.protobuf.StringValue attribute_unit_id = 3;
    google.protobuf.Int32Value min_value = 4;
    google.protobuf.Int32Value max_value = 5;
}

message ResourceAttribute {
	google.protobuf.StringValue id = 1;
	google.protobuf.StringValue resource_version_id = 2;
	repeated google.protobuf.StringValue attribute_ids = 3;
	repeated google.protobuf.StringValue metering_attribute_ids = 4;
}

message Sku {
	google.protobuf.StringValue id = 1;
	google.protobuf.StringValue resource_attribute_id = 2;
	repeated google.protobuf.StringValue attribute_value_ids = 3;
	google.protobuf.Timestamp action_time = 4;   // start/close/delete resource time for metering
}

message StepPrice {
	google.protobuf.StringValue attribute_value_id = 1; //the value that upto for the step price
    google.protobuf.FloatValue price = 2;
}

message Price {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue sku_id = 2;
    google.protobuf.StringValue attribute_id = 3; //metering attribute id
	repeated StepPrice prices = 4;
    Currency currency = 5;
}


message CreateAttributesRequest {
	repeated Attribute attributes = 1;
}

message CreateAttributeUnitsRequest {
	repeated AttributeUnit attribute_units = 1;
}

message CreateAttributeValuesRequest {
	repeated AttributeValue attribute_values = 1;
}

message CreateResourceAttributesRequest {
	repeated ResourceAttribute resource_attributes = 1;
}

message CreateSkusRequest {
	repeated Sku skus = 1;
}

message CreatePricesRequest {
	repeated Price prices = 1;
}

message CommonResponse {
	google.protobuf.Int32Value status = 1;
	google.protobuf.StringValue message = 2;
}


service SkuManager {
	rpc CreateAttributes (CreateAttributesRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "create attributes"
		};
		option (google.api.http) = {
			post: "/v1/billing/attribute"
			body: "*"
		};
	}

	rpc CreateAttributeUnits (CreateAttributeUnitsRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
            summary: "create attribute units"
        };
		option (google.api.http) = {
            post: "/v1/billing/attribute/units"
            body: "*"
        };
	}

	rpc CreateAttributeValues (CreateAttributeValuesRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
            summary: "create attribute values"
        };
		option (google.api.http) = {
            post: "/v1/billing/attribute/values"
            body: "*"
        };
	}

	rpc CreateResourceAttributes (CreateResourceAttributesRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
            summary: "create attributes of the resource"
        };
		option (google.api.http) = {
            post: "/v1/billing/resource/attributes"
            body: "*"
        };
	}

	rpc CreateSkus (CreateSkusRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
            summary: "create skus of the resource"
        };
		option (google.api.http) = {
            post: "/v1/billing/resource/skus"
            body: "*"
        };
	}

	rpc CreatePrices (CreatePricesRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
            summary: "create prices of the sku"
        };
		option (google.api.http) = {
            post: "/v1/billing/resource/sku/prices"
            body: "*"
        };
	}
}


//************************************* Promotion *************************

message CombinationResourceAttribute {
    google.protobuf.StringValue id = 1;
    repeated ResourceAttribute resource_attributes = 2;
}

message CombinationAttributeValue {
    google.protobuf.StringValue resource_version_id = 1;
	repeated google.protobuf.StringValue attribute_value_ids = 2;
}

message CombinationSku {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue cra_id = 2; //combination_resource_attribute id
	repeated CombinationAttributeValue values = 3;
	google.protobuf.Timestamp action_time = 4;
}

message CombinationPrice {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue combination_sku_id = 2;
    google.protobuf.StringValue resource_version_id = 3;
    google.protobuf.StringValue billing_attribute_id = 4;
	repeated StepPrice prices = 5;
	Currency currency = 6;
}

message ProbationSku {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue resource_attribute_id = 2;
	repeated google.protobuf.StringValue attribute_value_ids = 3;
    google.protobuf.Int32Value limit_num = 4;
	google.protobuf.Timestamp action_time = 5;
}

message ProbationRecord {
	google.protobuf.StringValue probation_sku_id = 1;
	google.protobuf.StringValue user_id = 2;
}

message Limit {
	enum Types {
		RESOURCE = 0;
		SKU = 1;
		PRICE = 2;
		USER = 3;
		REGOIN = 4;
	}
	Types type = 1;
    google.protobuf.StringValue id = 2; // the id of the TYPE
}

message Discount {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue name = 2;
	repeated Limit limits = 3;
    google.protobuf.FloatValue discount_value = 4;
    google.protobuf.FloatValue discount_percent = 5;
    google.protobuf.Timestamp start_time = 6;
    google.protobuf.Timestamp end_time = 7;
    google.protobuf.StringValue mark = 8;
}

message Coupon {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue name = 2;
	repeated Limit limits = 3;
    google.protobuf.FloatValue balance = 4;
    google.protobuf.Int32Value count = 5;
    google.protobuf.Int32Value limit_num = 6;
    google.protobuf.Timestamp start_time = 7;
    google.protobuf.Timestamp end_time = 8;
    google.protobuf.StringValue mark = 9;
}

message CouponReceived {
    google.protobuf.StringValue id = 1;
    google.protobuf.StringValue coupon_id = 2;
    google.protobuf.StringValue user_id = 3;
}


message CreateCRARequest { //CRA: CombinationResourceAttribute
	CombinationResourceAttribute combination_resource_attribute = 1;
}

message CreateCSRequest { //CreateCombinationSkuRequest
	CombinationSku combination_sku = 1;
}

message CreateCPRequest { //CreateCombinationPricesRequest
	repeated CombinationPrice prices = 1;
}

message CreatePSRequest { //CreateProbationSkuRequest
	ProbationSku sku = 1;
}

message CreatePRRequest { //CreateProbationRecordRequest
	ProbationRecord record = 1;
}


service PromotionManager {
	rpc CreateCRA (CreateCRARequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "create attributes of combination resources"
		};
		option (google.api.http) = {
			post: "/v1/billing/combination/resource/attributes"
			body: "*"
		};
	}

	rpc CreateCombinationSku (CreateCSRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "create combination sku of combination resources"
		};
		option (google.api.http) = {
			post: "/v1/billing/combination/resource/sku"
			body: "*"
		};
	}

	rpc CreateCombinationPrices (CreateCPRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "create combination prices of combination sku"
		};
		option (google.api.http) = {
			post: "/v1/billing/combination/resource/sku/prices"
			body: "*"
		};
	}

	rpc CreateProbationSku (CreatePSRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "create probation sku of resource"
		};
		option (google.api.http) = {
			post: "/v1/billing/probation/sku"
			body: "*"
		};
	}

	rpc CreateProbationRecord (CreatePRRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "create record of probation resource sku"
		};
		option (google.api.http) = {
			post: "/v1/billing/probation/record"
			body: "*"
		};
	}
}


//************************** metering ****************************

enum SkuTypes {
	NORMAL = 0;
	COMBATION = 1;
	PROBATION = 2;
}

enum UpdateValueTypes {
	INCREMENTAL = 0;
	REPLACE = 1;
}

message MeteringAttributeValue {
	google.protobuf.StringValue attribute_id = 1;
	google.protobuf.FloatValue value = 2;
	UpdateValueTypes type = 3;
}

message MeteringSku {
	google.protobuf.StringValue sku_id = 1;
	repeated MeteringAttributeValue attribute_values = 2;
	google.protobuf.Timestamp action_time = 3;
	google.protobuf.StringValue other_info = 4;
	SkuTypes type = 5;
}

message MeteringRequest {
	google.protobuf.StringValue resource_id = 1; //cluster id
	google.protobuf.StringValue user_id = 2;
	repeated MeteringSku sku_set = 3;
}

service MeteringManager {
	rpc StartMetering (MeteringRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "start metering about the sku_set"
		};
		option (google.api.http) = {
			post: "/v1/metering/skus"
			body: "*"
		};
	}

	rpc UpdateMetering (MeteringRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "update metering value about the sku_set"
		};
		option (google.api.http) = {
			put: "/v1/metering/skus"
			body: "*"
		};
	}

	rpc CloseMetering (MeteringRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
			summary: "pause metering value about the sku_set"
		};
		option (google.api.http) = {
			put: "/v1/metering/skus/pause"
			body: "*"
		};
	}

	rpc StopMetering (MeteringRequest) returns (CommonResponse) {
		option (grpc.gateway.protoc_gen_swagger.options.openapiv2_operation) = {
            summary: "stop metering about the sku_set"
        };
		option (google.api.http) = {
            delete: "/v1/metering/skus"
            body: "*"
        };
	}
}