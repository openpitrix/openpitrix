# Copyright 2017 The OpenPitrix Authors. All rights reserved.
# Use of this source code is governed by a Apache license
# that can be found in the LICENSE file.

version: '3'

services:
# TODO: run make build in docker-compose, go install will use cache
  openpitrix-db:
    image: "mysql:5.7"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${DATA_PATH}/mysql:/var/lib/mysql
      - ./pkg/db/ddl:/docker-entrypoint-initdb.d
    ports:
     - "13306:3306" # only for debug
    container_name: "openpitrix-db"
  openpitrix-etcd:
    image: "appcelerator/etcd"
    volumes:
      - ${DATA_PATH}/etcd:/data
    container_name: "openpitrix-etcd"

  openpitrix-app-manager:
    build: .
    image: "openpitrix"
    command: "app-manager"
    links:
      - openpitrix-db:openpitrix-db
      - openpitrix-etcd:openpitrix-etcd
    depends_on:
      - openpitrix-app-db-ctrl
      - openpitrix-etcd
    container_name: "openpitrix-app-manager"
    environment:
      - OPENPITRIX_LOG_LEVEL=${OPENPITRIX_LOG_LEVEL}
      - OPENPITRIX_MYSQL_DATABASE=app
  openpitrix-app-db-ctrl:
    image: boxfuse/flyway:latest-alpine
    command: -url=jdbc:mysql://openpitrix-db/app -user=root -password=${MYSQL_ROOT_PASSWORD} -validateOnMigrate=false migrate
    volumes:
      - ./pkg/db/schema/app:/flyway/sql
    links:
      - openpitrix-db:openpitrix-db
    depends_on:
      - openpitrix-db
    container_name: "openpitrix-app-db-ctrl"

  openpitrix-runtime-env-manager:
    build: .
    image: "openpitrix"
    command: "runtime-env-manager"
    links:
      - openpitrix-db:openpitrix-db
      - openpitrix-etcd:openpitrix-etcd
    depends_on:
      - openpitrix-runtime-db-ctrl
      - openpitrix-etcd
    container_name: "openpitrix-runtime-manager"
    environment:
      - OPENPITRIX_LOG_LEVEL=${OPENPITRIX_LOG_LEVEL}
      - OPENPITRIX_MYSQL_DATABASE=runtime
  openpitrix-runtime-db-ctrl:
    image: boxfuse/flyway:latest-alpine
    command: -url=jdbc:mysql://openpitrix-db/runtime -user=root -password=${MYSQL_ROOT_PASSWORD} -validateOnMigrate=false migrate
    volumes:
      - ./pkg/db/schema/runtime:/flyway/sql
    links:
      - openpitrix-db:openpitrix-db
    depends_on:
      - openpitrix-db
    container_name: "openpitrix-runtime-db-ctrl"

  openpitrix-repo-indexer:
    build: .
    image: "openpitrix"
    command: "repo-indexer"
    links:
      - openpitrix-db:openpitrix-db
      - openpitrix-etcd:openpitrix-etcd
      - openpitrix-repo-manager:openpitrix-repo-manager
    depends_on:
      - openpitrix-repo-db-ctrl
      - openpitrix-etcd
    container_name: "openpitrix-repo-indexer"
    environment:
      - OPENPITRIX_LOG_LEVEL=${OPENPITRIX_LOG_LEVEL}
      - OPENPITRIX_MYSQL_DATABASE=repo

  openpitrix-api-gateway:
    build: .
    image: "openpitrix"
    command: "api-gateway"
    ports:
     - "9100:9100"
    links:
      - openpitrix-app-manager:openpitrix-app-manager
      - openpitrix-runtime-env-manager:openpitrix-runtime-env-manager
    container_name: "openpitrix-api-gateway"
  openpitrix-repo-manager:
    build: .
    image: "openpitrix"
    command: "repo-manager"
    links:
      - openpitrix-db:openpitrix-db
    depends_on:
      - openpitrix-repo-db-ctrl
    environment:
      - OPENPITRIX_MYSQL_DATABASE=repo

  openpitrix-repo-db-ctrl:
    image: boxfuse/flyway:latest-alpine
    command: -url=jdbc:mysql://openpitrix-db/repo -user=root -password=${MYSQL_ROOT_PASSWORD} -validateOnMigrate=false migrate
    volumes:
      - ./pkg/db/schema/repo:/flyway/sql
    links:
      - openpitrix-db:openpitrix-db
    depends_on:
      - openpitrix-db