# Copyright 2017 The OpenPitrix Authors. All rights reserved.
# Use of this source code is governed by a Apache license
# that can be found in the LICENSE file.

version: '3'

services:
# TODO: run make build in docker-compose, go install will use cache
  openpitrix-db:
    image: "mysql:5.7"
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${DATA_PATH}/mysql:/var/lib/mysql
    ports:
     - "13306:3306" # only for debug
    container_name: "openpitrix-db"

  openpitrix-app-manager:
    build: .
    image: "openpitrix"
    command: "app-manager"
    links:
      - openpitrix-db:openpitrix-db
    container_name: "openpitrix-app-manager"

  openpitrix-runtime-env-manager:
      build: .
      image: "openpitrix"
      command: "runtime-env-manager"
      links:
        - openpitrix-db:openpitrix-db
      container_name: "openpitrix-runtime-env-manager"

  openpitrix-api-gateway:
    build: .
    image: "openpitrix"
    command: "api-gateway"
    ports:
     - "9100:9100"
    links:
      - openpitrix-app-manager:openpitrix-app-manager
      - openpitrix-runtime-env-manager:openpitrix-runtime-env-manager
    container_name: "openpitrix-api-gateway"

  openpitrix-db-ctrl:
    build: .
    image: "openpitrix"
    command: "db-ctrl -s /schema"
    restart: on-failure
    ports:
     - "9105:9105"
    links:
      - openpitrix-db:openpitrix-db
    container_name: "openpitrix-db-ctrl"


  openpitrix-repo-manager:
    build: .
    image: "openpitrix"
    command: "repo-manager"
    links:
      - openpitrix-db:openpitrix-db
    container_name: "openpitrix-repo-manager"
